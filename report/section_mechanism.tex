\section{Fault Tolerance}
\label{section:failure}

\subsection{client failure}

During a client failure, the leader server initiates release() operation for
all the locks previously held by the failed client. For garbage collection
purpose, the server also deletes all the file handlers opened by the client,
outstanding lock acquire requests sent by the client, and all the registered
events from the client.


\subsection{server failover}

When the leader server fails, the Paxos protocol elects a new leader. After
the leader change, all persistent data remain consistent. However, the in-memory
data structures at the new leader need to be reconstructed. The new leader
does this partially by scanning the persistent data. The other missing data
will be inferred from future client RPC requests.

To precisely reconstruct the queues of outstanding lock acquire requests and
the queues of registered event from clients, the client library should keep
a copy of these requests locally and send a set of reopen requests and
potentially a lock acquire request to the new leader after it reconnects
to the new leader after a leader change.

However, it is not necessary to reconstruct the information of all the file
handlers held by clients eagerly. Instead, we reconstruct the file handler
information in the normal case of the SimpleChubby processing after the
leader change. If the new leader receives a request with a file handler that
missing in the leader's memory, it checks the signiture of the file
handler and initiates a reopen. If the reopen succeeds (i.e. the node exits
and the meta data matches), the leader add this file handler into its memory.


